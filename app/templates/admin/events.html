{% extends "base.html" %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            {% if current_user.is_admin %}
                <a href="{{ url_for('main.admin_dashboard') }}"><i class="bi bi-gear"></i> Admin</a>
            {% else %}
                <a href="{{ url_for('main.manager_dashboard') }}"><i class="bi bi-kanban"></i> Manager</a>
            {% endif %}
        </li>
        <li class="breadcrumb-item">
            <a href="{{ url_for('main.manage_campaigns') if current_user.is_admin else url_for('main.manager_missions') }}">
                {% if current_user.is_admin %}Campaigns{% else %}Missions{% endif %}
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="{{ url_for('main.campaign_detail', campaign_id=mission.campaign_id) }}">Campaign</a>
        </li>
        <li class="breadcrumb-item">
            <a href="{{ url_for('main.campaign_missions', campaign_id=mission.campaign_id) }}">Missions</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">{{ mission.name }} Events</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('main.campaign_missions', campaign_id=mission.campaign_id) }}">
            ← Back to Missions
            {% if current_user.is_admin %}
                {% if session.get('test_manager_view') %}
                    <span class="badge bg-warning text-dark ms-2">TESTING MODE</span>
                {% endif %}
            {% endif %}
        </a>
        <div class="navbar-nav">
            {% if current_user.is_admin %}
                {% if session.get('test_manager_view') %}
                    <a class="nav-link btn btn-outline-danger btn-sm me-2" href="{{ url_for('main.switch_to_admin_view') }}">
                        <i class="bi bi-arrow-left-right"></i> Return to Admin
                    </a>
                {% else %}
                    <a class="nav-link" href="{{ url_for('main.admin_dashboard') }}">Admin Dashboard</a>
                {% endif %}
            {% else %}
                <a class="nav-link" href="{{ url_for('main.manager_dashboard') }}">Manager Dashboard</a>
            {% endif %}
            <a class="nav-link" href="{{ url_for('auth.logout') }}">Logout</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>Manage Events</h1>
            <p class="text-muted">
                Mission: <strong>{{ mission.name }}</strong> • 
                Date: {{ mission.mission_date.strftime('%Y-%m-%d') }}
            </p>
        </div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEventModal">
            <i class="bi bi-plus-circle"></i> Add Event
        </button>
    </div>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Events Timeline -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Events Timeline</h5>
            <span class="badge bg-primary">{{ events|length }} events</span>
        </div>
        <div class="card-body">
            {% if events %}
            {% for event in events|sort(attribute='event_date') %}
            <div class="card mb-3 event-card" id="event-{{ event.id }}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">
                            <i class="bi bi-{% if event.event_type == 'combat' %}exclamation-triangle{% elif event.event_type == 'logistics' %}truck{% else %}calendar-event{% endif %}"></i>
                            {{ event.title }}
                        </h6>
                        <small class="text-muted">
                            {{ event.event_date.strftime('%Y-%m-%d %H:%M') }}
                            {% if event.location %} • {{ event.location }}{% endif %}
                            • <span class="badge bg-secondary">{{ event.event_type|title }}</span>
                        </small>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary edit-event-btn"
                                data-id="{{ event.id }}"
                                data-title="{{ event.title }}"
                                data-description="{{ event.description or '' }}"
                                data-event-date="{{ event.event_date.strftime('%Y-%m-%dT%H:%M') }}"
                                data-location="{{ event.location or '' }}"
                                data-event-type="{{ event.event_type }}"
                                data-notes="{{ event.notes or '' }}">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-outline-danger delete-event-btn"
                                data-id="{{ event.id }}"
                                data-title="{{ event.title }}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if event.description %}
                        <p class="card-text">{{ event.description }}</p>
                    {% endif %}
                    
                    {% if event.notes %}
                        <div class="alert alert-light">
                            <strong>Notes:</strong> {{ event.notes }}
                        </div>
                    {% endif %}
                    
                    <!-- Asset Changes -->
                    <div class="mt-3">
                        <h6>Asset Changes</h6>
                        {% if event.asset_changes %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Asset</th>
                                        <th>Type</th>
                                        <th>Quantity Change</th>
                                        <th>Notes</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for change in event.asset_changes %}
                                    <tr class="{% if change.quantity_change > 0 %}table-success{% elif change.quantity_change < 0 %}table-danger{% endif %}">
                                        <td>{{ change.asset.name }}</td>
                                        <td>
                                            <span class="badge bg-primary">{{ change.asset.type }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-{% if change.quantity_change > 0 %}success{% else %}danger{% endif %}">
                                                {{ "+" if change.quantity_change > 0 }}{{ change.quantity_change }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if change.notes %}
                                                <small>{{ change.notes }}</small>
                                            {% else %}
                                                <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-danger delete-asset-change-btn"
                                                    data-id="{{ change.id }}"
                                                    data-asset="{{ change.asset.name }}">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            No asset changes recorded for this event.
                        </div>
                        {% endif %}
                        
                        <button class="btn btn-sm btn-outline-secondary add-asset-change-btn"
                                data-event-id="{{ event.id }}">
                            <i class="bi bi-plus"></i> Add Asset Change
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-calendar-event display-1 text-muted"></i>
                <h4 class="mt-3">No Events Yet</h4>
                <p class="text-muted">Add events to track asset changes during this mission.</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEventModal">
                    <i class="bi bi-plus-circle"></i> Add First Event
                </button>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Quick Stats -->
    <div class="row">
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary">{{ total_asset_changes }}</h3>
                    <p class="text-muted mb-0">Total Asset Changes</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success">{{ asset_gains }}</h3>
                    <p class="text-muted mb-0">Asset Gains</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-danger">{{ asset_losses }}</h3>
                    <p class="text-muted mb-0">Asset Losses</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Event Modal -->
<div class="modal fade" id="addEventModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('main.add_event') }}" id="addEventForm">
                <input type="hidden" name="mission_id" value="{{ mission.id }}">
                <input type="hidden" name="campaign_id" value="{{ mission.campaign_id }}">
                
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="event_title" class="form-label">Event Title *</label>
                            <input type="text" class="form-control" id="event_title" name="title" required
                                   placeholder="e.g., Convoy Ambush, Supply Drop, Base Attack">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="event_type" class="form-label">Event Type *</label>
                            <select class="form-select" id="event_type" name="event_type" required>
                                <option value="combat">Combat</option>
                                <option value="logistics">Logistics</option>
                                <option value="training">Training</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="event_date" class="form-label">Event Date & Time *</label>
                            <input type="datetime-local" class="form-control" id="event_date" name="event_date" required
                                   value="{{ default_event_time }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="event_location" class="form-label">Location</label>
                            <input type="text" class="form-control" id="event_location" name="location"
                                   placeholder="e.g., Highway 7, Airfield Alpha">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="event_description" class="form-label">Description</label>
                        <textarea class="form-control" id="event_description" name="description" rows="3"
                                  placeholder="What happened during this event?"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="event_notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="event_notes" name="notes" rows="2"
                                  placeholder="Additional notes, observations, or context..."></textarea>
                    </div>
                    
                    <!-- Asset Changes Section -->
                    <div class="mb-3">
                        <label class="form-label">Asset Changes (Optional)</label>
                        <div id="assetChangesContainer">
                            <div class="asset-change-row row mb-2">
                                <div class="col-md-4">
                                    <select class="form-select asset-select" name="asset_changes[0][asset_id]">
                                        <option value="">Select Asset</option>
                                        {% for asset in campaign_assets %}
                                        <option value="{{ asset.asset.id }}" 
                                                data-current-qty="{{ asset.current_quantity }}">
                                            {{ asset.asset.name }} ({{ asset.current_quantity }} available)
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="number" class="form-control quantity-change" 
                                           name="asset_changes[0][quantity_change]" 
                                           placeholder="Qty Change" 
                                           min="-999" max="999" value="0">
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" 
                                           name="asset_changes[0][notes]" 
                                           placeholder="Notes">
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-danger btn-sm remove-asset-change">
                                        <i class="bi bi-dash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="addAssetChange">
                            <i class="bi bi-plus"></i> Add Another Asset Change
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Event</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Event Modal -->
<div class="modal fade" id="editEventModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('main.edit_event') }}" id="editEventForm">
                <input type="hidden" name="event_id" id="edit_event_id">
                
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="edit_event_title" class="form-label">Event Title *</label>
                            <input type="text" class="form-control" id="edit_event_title" name="title" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="edit_event_type" class="form-label">Event Type *</label>
                            <select class="form-select" id="edit_event_type" name="event_type" required>
                                <option value="combat">Combat</option>
                                <option value="logistics">Logistics</option>
                                <option value="training">Training</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_event_date" class="form-label">Event Date & Time *</label>
                            <input type="datetime-local" class="form-control" id="edit_event_date" name="event_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_event_location" class="form-label">Location</label>
                            <input type="text" class="form-control" id="edit_event_location" name="location">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_event_description" class="form-label">Description</label>
                        <textarea class="form-control" id="edit_event_description" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_event_notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="edit_event_notes" name="notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Asset Change Modal -->
<div class="modal fade" id="addAssetChangeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Asset Change</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('main.add_asset_change') }}" id="addAssetChangeForm">
                <input type="hidden" name="event_id" id="asset_change_event_id">
                
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="asset_change_asset" class="form-label">Asset *</label>
                        <select class="form-select" id="asset_change_asset" name="asset_id" required>
                            <option value="">Select Asset</option>
                            {% for asset in campaign_assets %}
                            <option value="{{ asset.asset.id }}" 
                                    data-current-qty="{{ asset.current_quantity }}">
                                {{ asset.asset.name }} ({{ asset.current_quantity }} available)
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="asset_change_quantity" class="form-label">Quantity Change *</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="asset_change_quantity" 
                                   name="quantity_change" required min="-999" max="999" value="0">
                            <div class="input-group-text">
                                currently available: <span id="currentQuantity">0</span>
                            </div>
                        </div>
                        <small class="text-muted">Positive numbers for gains, negative for losses</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="asset_change_notes" class="form-label">Notes</label>
                        <input type="text" class="form-control" id="asset_change_notes" name="notes"
                               placeholder="e.g., Destroyed in combat, Received from HQ">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Change</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Modals -->
<div class="modal fade" id="deleteEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete event: <strong id="deleteEventTitle"></strong>?</p>
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    This will also delete all asset changes associated with this event.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('main.delete_event') }}" id="deleteEventForm">
                    <input type="hidden" name="event_id" id="delete_event_id">
                    <button type="submit" class="btn btn-danger">Delete Event</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteAssetChangeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Asset Change</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this asset change for <strong id="deleteAssetChangeName"></strong>?</p>
                <p class="text-danger"><small>This will update the current asset quantities.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('main.delete_asset_change') }}" id="deleteAssetChangeForm">
                    <input type="hidden" name="change_id" id="delete_change_id">
                    <button type="submit" class="btn btn-danger">Delete Change</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set default event time to mission date at 12:00
    const missionDate = '{{ mission.mission_date.strftime("%Y-%m-%d") }}';
    const defaultTime = missionDate + 'T12:00';  // Use 12:00 as default
    document.getElementById('event_date').value = defaultTime;
    
    // Asset Change counter for add form
    let assetChangeCounter = 1;
    
    // Add Asset Change row
    document.getElementById('addAssetChange').addEventListener('click', function() {
        const container = document.getElementById('assetChangesContainer');
        const newRow = document.createElement('div');
        newRow.className = 'asset-change-row row mb-2';
        newRow.innerHTML = `
            <div class="col-md-4">
                <select class="form-select asset-select" name="asset_changes[${assetChangeCounter}][asset_id]">
                    <option value="">Select Asset</option>
                    {% for asset in campaign_assets %}
                    <option value="{{ asset.asset.id }}" 
                            data-current-qty="{{ asset.current_quantity }}">
                        {{ asset.asset.name }} ({{ asset.current_quantity }} available)
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <input type="number" class="form-control quantity-change" 
                       name="asset_changes[${assetChangeCounter}][quantity_change]" 
                       placeholder="Qty Change" 
                       min="-999" max="999" value="0">
            </div>
            <div class="col-md-4">
                <input type="text" class="form-control" 
                       name="asset_changes[${assetChangeCounter}][notes]" 
                       placeholder="Notes">
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-danger btn-sm remove-asset-change">
                    <i class="bi bi-dash"></i>
                </button>
            </div>
        `;
        container.appendChild(newRow);
        assetChangeCounter++;
    });
    
    // Remove Asset Change row
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-asset-change') || 
            e.target.closest('.remove-asset-change')) {
            const row = e.target.closest('.asset-change-row');
            if (row) {
                row.remove();
            }
        }
    });
    
    // Show current quantity when selecting asset
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('asset-select')) {
            const selectedOption = e.target.options[e.target.selectedIndex];
            const currentQty = selectedOption.dataset.currentQty || 0;
            const inputGroup = e.target.closest('.asset-change-row').querySelector('.quantity-change');
            if (inputGroup) {
                // You could show a tooltip or update a label here
            }
        }
    });
    
    // Edit Event Modal
    const editEventModal = new bootstrap.Modal(document.getElementById('editEventModal'));
    const editEventForm = document.getElementById('editEventForm');
    
    document.querySelectorAll('.edit-event-btn').forEach(button => {
        button.addEventListener('click', function() {
            document.getElementById('edit_event_id').value = this.dataset.id;
            document.getElementById('edit_event_title').value = this.dataset.title;
            document.getElementById('edit_event_description').value = this.dataset.description || '';
            document.getElementById('edit_event_date').value = this.dataset.eventDate;
            document.getElementById('edit_event_location').value = this.dataset.location || '';
            document.getElementById('edit_event_type').value = this.dataset.eventType;
            document.getElementById('edit_event_notes').value = this.dataset.notes || '';
            
            editEventModal.show();
        });
    });
    
    // Delete Event Modal
    const deleteEventModal = new bootstrap.Modal(document.getElementById('deleteEventModal'));
    
    document.querySelectorAll('.delete-event-btn').forEach(button => {
        button.addEventListener('click', function() {
            document.getElementById('deleteEventTitle').textContent = this.dataset.title;
            document.getElementById('delete_event_id').value = this.dataset.id;
            
            deleteEventModal.show();
        });
    });
    
    // Add Asset Change Modal
    const addAssetChangeModal = new bootstrap.Modal(document.getElementById('addAssetChangeModal'));
    const addAssetChangeForm = document.getElementById('addAssetChangeForm');
    
    document.querySelectorAll('.add-asset-change-btn').forEach(button => {
        button.addEventListener('click', function() {
            document.getElementById('asset_change_event_id').value = this.dataset.eventId;
            addAssetChangeModal.show();
        });
    });
    
    // Delete Asset Change Modal
    const deleteAssetChangeModal = new bootstrap.Modal(document.getElementById('deleteAssetChangeModal'));
    
    document.querySelectorAll('.delete-asset-change-btn').forEach(button => {
        button.addEventListener('click', function() {
            document.getElementById('deleteAssetChangeName').textContent = this.dataset.asset;
            document.getElementById('delete_change_id').value = this.dataset.id;
            
            deleteAssetChangeModal.show();
        });
    });
    
    // Show current quantity in add asset change modal
    document.getElementById('asset_change_asset').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const currentQty = selectedOption.dataset.currentQty || 0;
        document.getElementById('currentQuantity').textContent = currentQty;
    });
    
    // Form submissions
    editEventForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        fetch(this.action, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating event');
        });
    });
    
    addAssetChangeForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        fetch(this.action, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error adding asset change');
        });
    });
});
</script>
{% endblock %}