{% extends "base.html" %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item active" aria-current="page">
            <i class="bi bi-kanban"></i> Manager Dashboard
        </li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('main.manager_dashboard') }}">
            <i class="bi bi-kanban"></i> Manager Dashboard
            <span class="badge bg-primary ms-2">MANAGER</span>
            {% if current_user.is_admin %}
                <span class="badge bg-warning text-dark ms-1">TESTING MODE</span>
            {% endif %}
        </a>
        <div class="navbar-nav ms-auto">
            <span class="navbar-text me-3">
                <a href="{{ url_for('main.user_profile') }}"><i class="bi bi-person-circle"></i> {{ current_user.username }}</a>
            </span>
            {% if current_user.is_admin %}
                <a class="nav-link btn btn-outline-danger btn-sm me-2" href="{{ url_for('main.switch_to_admin_view') }}">
                    <i class="bi bi-arrow-left-right"></i> Return to Admin
                </a>
            {% endif %}
            <a class="nav-link" href="{{ url_for('main.index') }}">Public View</a>
            <a class="nav-link" href="{{ url_for('auth.logout') }}">Logout</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="row mb-4">
        <div class="col-md-12">
            <h1>Welcome, {{ current_user.username }}!</h1>
            <p class="text-muted">You can manage the active campaign including missions, events, and asset tracking.</p>
        </div>
    </div>

    {% if campaign %}
    <!-- Active Campaign Card -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-star-fill"></i> Active Campaign: {{ campaign.name }}
                    </h5>
                    <span class="badge bg-light text-dark">Active</span>
                </div>
                <div class="card-body">
                    <p class="lead">{{ campaign.description or 'No description' }}</p>
                    {% if campaign.start_date %}
                        <p class="text-muted mb-3">
                            <i class="bi bi-calendar"></i> Started: {{ campaign.start_date.strftime('%B %d, %Y') }}
                        </p>
                    {% endif %}
                    
                    <div class="d-flex gap-2 flex-wrap">
                        <a href="{{ url_for('main.manager_campaign') }}" class="btn btn-primary">
                            <i class="bi bi-gear"></i> Manage Assets
                        </a>
                        <a href="{{ url_for('main.manager_missions') }}" class="btn btn-outline-primary">
                            <i class="bi bi-map"></i> Manage Missions
                        </a>
                        <a href="{{ url_for('main.view_campaign_report', campaign_id=campaign.id) }}" class="btn btn-outline-secondary">
                            <i class="bi bi-file-earmark-text"></i> View Report
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="bi bi-box display-4 text-primary"></i>
                    <h3 class="mt-2">{{ asset_summary.total }}</h3>
                    <p class="text-muted mb-0">Total Assets</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="bi bi-exclamation-triangle display-4 text-warning"></i>
                    <h3 class="mt-2">{{ asset_summary.low_stock }}</h3>
                    <p class="text-muted mb-0">Low Stock Items</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="bi bi-x-circle display-4 text-danger"></i>
                    <h3 class="mt-2">{{ asset_summary.depleted }}</h3>
                    <p class="text-muted mb-0">Depleted Assets</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Missions -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-map"></i> Recent Missions
                    </h5>
                </div>
                <div class="card-body">
                    {% if missions %}
                    <div class="list-group">
                        {% for mission in missions %}
                        <a href="{{ url_for('main.mission_events', mission_id=mission.id) }}" 
                           class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ mission.name }}</h6>
                                <small>
                                    {% if mission.status == 'completed' %}
                                        <span class="badge bg-success">Completed</span>
                                    {% elif mission.status == 'in_progress' %}
                                        <span class="badge bg-primary">In Progress</span>
                                    {% elif mission.status == 'planned' %}
                                        <span class="badge bg-secondary">Planned</span>
                                    {% else %}
                                        <span class="badge bg-warning">{{ mission.status|title }}</span>
                                    {% endif %}
                                </small>
                            </div>
                            <small class="text-muted">
                                <i class="bi bi-calendar"></i> {{ mission.mission_date.strftime('%Y-%m-%d') }}
                            </small>
                        </a>
                        {% endfor %}
                    </div>
                    <div class="mt-3">
                        <a href="{{ url_for('main.manager_missions') }}" class="btn btn-sm btn-outline-primary">
                            View All Missions
                        </a>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> No missions yet. Create your first mission!
                    </div>
                    <a href="{{ url_for('main.manager_missions') }}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Add Mission
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Recent Events -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history"></i> Recent Events
                    </h5>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {% if recent_events %}
                    <div class="list-group">
                        {% for event in recent_events %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ event.title }}</h6>
                                <small>
                                    <span class="badge bg-secondary">{{ event.type|title }}</span>
                                </small>
                            </div>
                            <small class="text-muted">
                                <strong>{{ event.mission }}</strong> â€¢ 
                                {{ event.date.strftime('%Y-%m-%d %H:%M') }}
                            </small>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> No events recorded yet.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- No Active Campaign -->
    <div class="row">
        <div class="col-md-12">
            <div class="alert alert-warning">
                <h4><i class="bi bi-exclamation-triangle"></i> No Active Campaign</h4>
                <p>There is currently no active campaign. Please contact an administrator to activate a campaign.</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}